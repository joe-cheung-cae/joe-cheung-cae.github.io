---
interface Props {
  headings: Array<{ depth: number; slug: string; text: string }>;
}

const { headings } = Astro.props;

// Filter to h2 and h3 only
const tocItems = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

{tocItems.length > 0 && (
  <div class="bg-notion-gray dark:bg-notion-gray-dark/50 rounded-lg p-4">
    <h2 class="text-sm font-semibold text-notion-text dark:text-notion-text-dark mb-3">
      On this page
    </h2>
    <nav>
      <ul class="space-y-1">
        {tocItems.map((heading) => (
          <li class={heading.depth === 3 ? 'ml-3' : ''}>
            <a
              href={`#${heading.slug}`}
              class="block text-sm text-notion-text dark:text-notion-text-dark/70 hover:text-notion-blue transition-colors py-1"
              data-toc-link
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
)}

<script>
  // Highlight active TOC item on scroll
  const tocLinks = document.querySelectorAll('[data-toc-link]');
  const headings = document.querySelectorAll('h2[id], h3[id]');

  const observerOptions = {
    root: null,
    rootMargin: '-20% 0px -80% 0px',
    threshold: 0,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('id');
        tocLinks.forEach((link) => {
          link.classList.remove('text-notion-blue', 'font-medium');
          link.classList.add('text-notion-text', 'dark:text-notion-text-dark/70');
          if (link.getAttribute('href') === `#${id}`) {
            link.classList.remove('text-notion-text', 'dark:text-notion-text-dark/70');
            link.classList.add('text-notion-blue', 'font-medium');
          }
        });
      }
    });
  }, observerOptions);

  headings.forEach((heading) => observer.observe(heading));
</script>
